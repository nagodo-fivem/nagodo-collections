local UTILS = exports['nagodo-utils']:GetUtils()
local DATABASE = Database()

Citizen.CreateThread(function()
    DATABASE.Init()

end)

function OpenCreatorMenu() 
    TriggerClientEvent("nagodo-collections:openCreatorMenu", -1)
end

--Callbacks--
UTILS.CreateCallback('nagodo-collections:server:getAllCollections', function(source, cb)
    local collections = DATABASE.GetAllCollections()
    cb(collections)
end)

UTILS.CreateCallback('nagodo-collections:server:createNewCollection', function(source, cb, collection)
    
    local result = DATABASE.CreateCollection(collection)

    local collections = DATABASE.GetAllCollections()
   
    cb(collections)
end)

UTILS.CreateCallback('nagodo-collections:server:getAllProperties', function(source, cb)
    local properties = DATABASE.GetAllProperties()
    cb(properties)
end)

UTILS.CreateCallback('nagodo-collections:server:createNewProperty', function(source, cb, property)
    
    local result = DATABASE.CreateProperty(property)

    local properties = DATABASE.GetAllProperties()
   
    cb(properties)
end)

UTILS.CreateCallback('nagodo-collections:server:saveCard', function(source, cb, payload)
    
    if payload.card.identifier == -1 then
        DATABASE.CreateCard(payload.collectionIdentifier, payload.card)
    else
        DATABASE.UpdateCard(payload.card)
    end

    local cards = DATABASE.GetAllCards(payload.collectionIdentifier)

    cb(cards)
end)

function decode_base64(data)
    local b64chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'
    local decchars = {}
    for i = 1, 64 do
        decchars[string.sub(b64chars, i, i)] = i
    end
    data = string.gsub(data, '[^'..b64chars..'=]', '')
    return (data:gsub('.', function(x)
        if x == '=' then return '' end
        local r, f = '', (decchars[x] - 1)
        for i = 6, 1, -1 do
            r = r..(f % 2^i - f % 2^(i - 1) > 0 and '1' or '0')
        end
        return r
    end):gsub('%d%d%d?%d?%d?%d?%d?%d?', function(x)
        if (#x ~= 8) then return '' end
        local c = 0
        for i = 1, 8 do
            c = c + (string.sub(x, i, i) == '1' and 2^(8 - i) or 0)
        end
        return string.char(c)
    end))
end

-- Event to save the image
RegisterNetEvent('nagodo-collections:server:saveImage', function(base64)

    local prefix = "data:image/png;base64,"
    local base64_data = string.gsub(base64, prefix, '')  -- Remove the prefix
    local decodedImage = decode_base64(base64_data)
    if not decodedImage then
        print("No image to write.")
        return
    end

    local file, err = io.open("t.png", "wb") -- Open file in binary mode
    if not file then
        print("Failed to open file:", err)
        return
    end

    local success, write_err = file:write(decodedImage)
    if not success then
        print("Failed to write to file:", write_err)
    else
        print("File written successfully. File size: ", #decodedImage)
    end

    file:close()
end)

-- local test = "data:image/png;base64,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"

-- TriggerEvent('nagodo-collections:server:saveImage', test)